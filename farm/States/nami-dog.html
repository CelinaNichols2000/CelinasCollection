<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trapped as Nami's Loyal Dog</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <!-- GLOBAL CHECKER -->
    <script>(function(){const s=JSON.parse(localStorage.getItem('farmState')||'{}');if(s.trappedUntil&&s.trappedUntil>Date.now()){}else{localStorage.removeItem('farmState');window.location.href='../../index.html';}})();</script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #0f1a2a 0%, #1a2535 100%);
            color: #fff;
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 30px;
        }

        /* TIMER ANIMATIONS */
        @keyframes timerExplode {
            0%, 100% { 
                font-size:8rem;transform:scale(1) rotate(0deg);
                text-shadow:0 0 80px #4A90E2,0 0 160px #2E5FFF;filter:brightness(1);
            }
            25% { font-size:10rem;transform:scale(1.4) rotate(5deg);filter:brightness(1.4); }
            50% { font-size:12rem;transform:scale(1.8) rotate(-8deg);filter:brightness(1.8); }
            75% { font-size:10rem;transform:scale(1.4) rotate(3deg);filter:brightness(1.4); }
        }

        @keyframes bulkyFlash {
            0% { opacity:0;transform:scale(0.3) translateY(50px) rotate(-15deg); }
            15% { opacity:1;transform:scale(1.1) translateY(0) rotate(2deg); }
            85% { opacity:1;transform:scale(1.05) translateY(-10px) rotate(1deg); }
            100% { opacity:0;transform:scale(1.4) translateY(-80px) rotate(180deg); }
        }

        /* TIMER TOP CENTER */
        .timer-display {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 700;
            color: #4A90E2;
            text-align: center;
            text-shadow: 0 0 30px #2E5FFF, 0 0 60px #4A90E2;
            letter-spacing: 8px;
            margin-bottom: 10px;
        }

        /* MAIN PANEL: IMAGE LEFT + UI RIGHT */
        .main-panel {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 40px;
            max-width: 1200px;
            width: 100%;
            align-items: start;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* DOG IMAGE */
        .dog-image-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 480px;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(74, 144, 226, 0.4);
            border: 2px solid rgba(74, 144, 226, 0.5);
        }

        .dog-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.8s ease, filter 0.5s ease;
        }

        .dog-image.active {
            opacity: 1;
        }

        /* RIGHT PANEL */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
        }

        /* TITLE + BADGE */
        .item-header {
            text-align: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, #4A90E2, #2E5FFF, #6FC6FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
            margin-bottom: 8px;
            letter-spacing: 2px;
        }

        .category-badge {
            background: linear-gradient(45deg, #4A90E2, #6FC6FF);
            color: #fff;
            padding: 8px 20px;
            border-radius: 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            box-shadow: 0 5px 20px rgba(74, 144, 226, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* OBEDIENCE CONTAINER */
        .obedience-container {
            background: rgba(74, 144, 226, 0.12);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(74, 144, 226, 0.6);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 15px 40px rgba(74, 144, 226, 0.3);
        }

        .obedience-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .obedience-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            color: #6FC6FF;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .obedience-percentage {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #90EE90, #32CD32);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .obedience-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(74, 144, 226, 0.5);
            position: relative;
        }

        .obedience-fill {
            height: 100%;
            background: linear-gradient(90deg, #4A90E2, #2E5FFF, #6FC6FF, #89CFF0);
            transition: width 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.9);
        }

        .obedience-stages {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 0.85rem;
            color: #ccc;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* ACTION BUTTONS */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .action-btn {
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            padding: 16px 20px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .action-btn:hover {
            transform: translateY(-3px) scale(1.05);
            filter: brightness(1.15);
        }

        .action-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .resist-btn {
            background: linear-gradient(45deg, #4A90E2, #2E5FFF);
            color: #fff;
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.6);
        }

        .bark-btn {
            background: linear-gradient(45deg, #90EE90, #32CD32);
            color: #000;
            box-shadow: 0 8px 25px rgba(50, 205, 50, 0.6);
            font-weight: 800;
        }

        .fetch-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
            font-weight: 800;
        }

        .obey-btn {
            background: linear-gradient(45deg, #FF1493, #FF69B4, #DC143C);
            color: #fff;
            box-shadow: 0 8px 25px rgba(255, 20, 147, 0.6);
            text-shadow: 0 0 8px rgba(220, 20, 60, 0.8);
        }

        /* OBEDIENCE PROGRESS PULSES */
        #obedienceFill.pulsing {
            animation: obediencePulse 0.8s ease-out;
        }

        @keyframes obediencePulse {
            0% { transform: scaleX(1); }
            50% { transform: scaleX(1.05); }
            100% { transform: scaleX(1); }
        }

        /* LOWER SECTION - FULL WIDTH CENTERED */
        .lower-section {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
        }

        .dog-status {
            background: rgba(74, 144, 226, 0.15);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(74, 144, 226, 0.7);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(74, 144, 226, 0.25);
        }

        .dog-status h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            color: #4A90E2;
            margin-bottom: 15px;
            letter-spacing: 2px;
            text-shadow: 0 0 15px #2E5FFF;
        }

        .dog-status p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 8px;
            color: #eee;
        }

        .degradation-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            font-size: 1rem;
        }

        .stat-item {
            background: rgba(144, 238, 144, 0.1);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(50, 205, 50, 0.4);
            text-align: center;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #90EE90;
        }

        /* MEMORY FRAGMENTS */
        .memory-fragments {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .memory-fragment {
            background: rgba(20, 20, 30, 0.8);
            border: 1px solid rgba(74, 144, 226, 0.4);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .memory-fragment:hover {
            border-color: #4A90E2;
            box-shadow: 0 10px 30px rgba(74, 144, 226, 0.3);
            transform: translateY(-2px);
        }

        .memory-trigger {
            padding: 18px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.05rem;
            background: linear-gradient(90deg, rgba(74, 144, 226, 0.2), rgba(144, 238, 144, 0.15));
            transition: all 0.3s ease;
            user-select: none;
        }

        .memory-trigger:hover {
            background: linear-gradient(90deg, #4A90E2, #90EE90);
            color: #000;
            font-weight: 700;
        }

        .memory-content {
            display: none;
            padding: 20px;
            background: rgba(10, 10, 20, 0.95);
            font-style: italic;
            color: #ddd;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .memory-content.active {
            display: block;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* DOG STRUGGLE POPUP */
        .dog-flash {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            background: radial-gradient(circle at center, rgba(74,144,226,0.35), rgba(0,0,0,0.95));
            animation: glitch 0.35s infinite;
        }

        .dog-flash-inner {
            max-width: 680px;
            width: 90%;
            background: linear-gradient(135deg, #1a2535, #0f1a2a);
            border: 2px solid #4A90E2;
            box-shadow: 0 0 40px rgba(74,144,226,0.9);
            border-radius: 18px;
            padding: 18px 22px;
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 18px;
        }

        .dog-flash-image {
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            min-height: 160px;
            box-shadow: 0 0 25px rgba(74,144,226,0.8);
        }

        .dog-flash-text {
            font-size: 1rem;
            line-height: 1.5;
            color: #b0d4ff;
            font-weight: 600;
            text-shadow: 0 0 8px rgba(74,144,226,0.9);
        }

        .dog-flash-text span.dog-scream {
            color: #4A90E2;
            font-weight: 800;
        }

        @media (max-width: 650px) {
            .dog-flash-inner {
                grid-template-columns: 1fr;
            }
            .dog-flash-image {
                min-height: 140px;
            }
        }

        /* PROGRESSIVE MEMORY PERSPECTIVES */
        .master-speak {
            color: #4A90E2 !important;
            font-weight: 800;
            text-shadow: 0 0 12px #2E5FFF;
            font-style: italic;
        }

        .scream {
            color: #FF4500 !important;
            font-weight: 900;
            font-size: 1.1em;
            text-shadow: 0 0 10px #FF4500;
            animation: screamShake 0.5s infinite;
        }

        .happy-dog {
            color: #90EE90 !important;
            font-weight: 700;
            text-shadow: 0 0 12px #32CD32;
        }

        .final-dog {
            color: #FFD700 !important;
            font-weight: 800;
            font-size: 1.15em;
            text-shadow: 0 0 20px #FFA500;
            background: linear-gradient(45deg, rgba(255,215,0,0.2), rgba(255,165,0,0.2));
            padding: 4px 8px;
            border-radius: 6px;
        }

        @keyframes screamShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(2px); }
            75% { transform: translateX(-2px); }
        }

        /* STAGE VISUALS */
        .memory-fragment[data-stage="0"] .memory-trigger { border-left: 4px solid #4A90E2; }
        .memory-fragment[data-stage="1"] .memory-trigger { border-left: 4px solid #2E5FFF; }
        .memory-fragment[data-stage="2"] .memory-trigger { border-left: 4px solid #6FC6FF; }
        .memory-fragment[data-stage="3"] .memory-trigger { border-left: 4px solid #90EE90; }
        .memory-fragment[data-stage="4"] .memory-trigger { border-left: 4px solid #FFD700; }

        /* OBEDIENCE LOCKOUT */
        .memory-fragment.locked {
            opacity: 0.4;
            pointer-events: none;
        }

        .memory-fragment.locked .memory-trigger {
            background: linear-gradient(90deg, rgba(74,144,226,0.3), rgba(46,95,255,0.3)) !important;
            color: #666 !important;
        }

        .memory-fragment.unlocked {
            border-color: #90EE90 !important;
            box-shadow: 0 0 20px rgba(144,238,144,0.4) !important;
        }

        /* ANIMATIONS */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }

        .mind-broken {
            filter: grayscale(100%) brightness(0.6) !important;
            opacity: 0.8;
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .main-panel {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
            
            .dog-image-container {
                max-width: 320px;
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- REAL TIME CLOCK TOP -->
        <div class="timer-display" id="countdownTimer">--:--:--</div>

        <!-- MAIN PANEL -->
        <div class="main-panel">
            <!-- LEFT: DOG IMAGE -->
            <div class="left-panel">
                <div class="dog-image-container">
                    <img src="https://i.ibb.co/RT7GmD7d/d4.jpg" class="dog-image active" data-stage="0">
                    <img src="https://i.ibb.co/XkrkN15D/d7.jpg" class="dog-image" data-stage="1">
                    <img src="https://i.ibb.co/fzDV6NbM/d3.png" class="dog-image" data-stage="2">
                    <img src="https://i.ibb.co/mV6DRnbb/d18.png" class="dog-image" data-stage="3">
                </div>
            </div>

            <!-- DOG STRUGGLE POPUP -->
            <div id="dogStrugglePopup" class="dog-flash" style="display:none;">
                <div class="dog-flash-inner">
                    <div class="dog-flash-image" id="dogFlashImage"></div>
                    <div class="dog-flash-text" id="dogFlashText"></div>
                </div>
            </div>

            <!-- RIGHT: UI PANEL -->
            <div class="right-panel">
                <div class="item-header">
                    <h1 class="item-title">Nami's Loyal Hound</h1>
                    <div class="category-badge">Nami's Punishment</div>
                </div>

                <!-- OBEDIENCE -->
                <div class="obedience-container">
                    <div class="obedience-header">
                        <div class="obedience-title">CANINE OBEDIENCE</div>
                        <div class="obedience-percentage" id="obediencePercentage">0%</div>
                    </div>
                    <div class="obedience-bar">
                        <div class="obedience-fill" id="obedienceFill" style="width: 0%"></div>
                    </div>
                    <div class="obedience-stages">
                        <span>HUMAN</span>
                        <span>SHIFTING</span>
                        <span>CANINE</span>
                        <span>LOYAL PET</span>
                    </div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="action-buttons">
                    <button class="action-btn resist-btn" onclick="resist()">RESIST TRANSFORMATION</button>
                    <button class="action-btn bark-btn" onclick="bark()">BARK LOUDLY</button>
                    <button class="action-btn fetch-btn" onclick="fetch()">FETCH OBEDIENTLY</button>
                    <button class="action-btn obey-btn" onclick="obey()">SUBMIT TO NAMI</button>
                </div>
            </div>
        </div>

        <!-- LOWER SECTION - FULL WIDTH -->
        <div class="lower-section">
            <details style="cursor: pointer;">
                <summary style="
                    margin-top: 30px;
                    font-family: 'Orbitron', sans-serif;
                    font-size: 1.8rem;
                    font-weight: 700;
                    color: #4A90E2;
                    padding: 20px;
                    list-style: none;
                    background: rgba(74, 144, 226, 0.15);
                    border-radius: 20px;
                    border: 2px solid rgba(74, 144, 226, 0.6);
                    text-align: center;
                    text-shadow: 0 0 15px #2E5FFF;
                    margin-bottom: 10px;
                ">Your Loyal Dog Existence</summary>

                <div class="dog-status">
                    <p>Paws instead of hands. Tail wagging involuntarily. Collar locked around your neck. Every instinct screams obedience to Nami...</p>
                    <p id="statusText">Transformation spreading... mind simplifying... </p>
                    
                    <div class="degradation-stats" id="degradationStats">
                        <div class="stat-item">
                            Human Memory: <span class="stat-value" id="memoryLoss">100%</span>
                        </div>
                        <div class="stat-item">
                            Loyalty Urge: <span class="stat-value" id="selfAwareness">0%</span>
                        </div>
                        <div class="stat-item">
                            Pet Acceptance: <span class="stat-value" id="objectPerception">0%</span>
                        </div>
                    </div>
                </div>

                <div class="memory-fragments">
                    <!-- #1: PURE RESISTANCE (0-25%) -->
                    <div class="memory-fragment" data-stage="0">
                        <div class="memory-trigger" onclick="toggleMemory(0)">#1: HUMAN PANIC</div>
                        <div class="memory-content">
                            <span class="scream">NO! THIS ISN'T REAL!</span> Spine cracking, limbs reshaping into paws. Fur sprouting across skin. Ears stretching, moving. <span class="scream">I'M STILL HUMAN!</span> But the collar grows heavier, and her voice sounds so commanding now... so... right?
                        </div>
                    </div>

                    <!-- #2: DESPERATE FIGHT (25-50%) -->
                    <div class="memory-fragment" data-stage="1">
                        <div class="memory-trigger" onclick="toggleMemory(1)">#2: BODY FAILURE</div>
                        <div class="memory-content">
                            Can't stand anymore. Four legs, four legs only. Tongue hanging out, can't pull it back. Nose twitching at every scent. <span class="scream">NAMI, PLEASE!</span> But only a whine comes out. She smiles. <span class="master-speak">"Good boy... such a pretty puppy..."</span> Why does that make my tail wag?
                        </div>
                    </div>

                    <!-- #3: CONFUSED SUBMISSION (50-75%) -->
                    <div class="memory-fragment" data-stage="2">
                        <div class="memory-trigger" onclick="toggleMemory(2)">#3: PACK INSTINCT</div>
                        <div class="memory-content">
                            Words mean nothing now. But HER voice? <span class="happy-dog">Perfect. Everything. Right.</span> When she commands, legs move on their own. When she praises, chest swells with pride. She's my master, my alpha, my whole world. Treats taste better than any human food ever did. Belly rubs make me forget everything.
                        </div>
                    </div>

                    <!-- #4: DOG IDENTITY (75-90%) -->
                    <div class="memory-fragment" data-stage="3">
                        <div class="memory-trigger" onclick="toggleMemory(3)">#4: PERFECT HOUND</div>
                        <div class="memory-content">
                            <span class="happy-dog">Woof~ Woof~</span> The sounds come naturally now. Every muscle responds to her slightest gesture. Fetch, sit, stay, heel‚Äîthese are my purpose. These are my joy. <span class="master-speak">"Best dog in the kingdom."</span> Pride swells. No human thoughts. Only love. Only loyalty. Only Nami.
                        </div>
                    </div>

                    <!-- #5: TOTAL DOG JOY (90%+) -->
                    <div class="memory-fragment" data-stage="4">
                        <div class="memory-trigger" onclick="toggleMemory(4)">#5: NAMI'S LOYAL PET</div>
                        <div class="memory-content">
                            <span class="final-dog">Bark bark~ üíï Good dog. Best dog. Perfect hound. üíï</span><br>
                            No past. No memories of being anything else. This is life: serve master, earn pets, wag tail. She says sit, I sit. She says stay, I stay. She calls, I come running. Ears up, tail wagging, tongue out. <span class="master-speak">"My perfect puppy forever."</span> <span class="happy-dog">Woof~ üêïüíï</span>
                        </div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        // STATE MANAGEMENT
        const state = JSON.parse(localStorage.getItem('farmState') || '{}');
        const endTime = state.trappedUntil;
        let obedienceLevel = parseInt(localStorage.getItem('dogObedience') || '0');
        let resistanceClicks = parseInt(localStorage.getItem('dogClicks') || '0');

        // OBEDIENCE STAGES
        const obedienceStages = [
            {title: "STILL RESISTING", color: "#4A90E2", memory: 100, loyalty: 0, pet: 0},
            {title: "BODY SHIFTING", color: "#2E5FFF", memory: 60, loyalty: 30, pet: 40},
            {title: "CANINE MIND", color: "#6FC6FF", memory: 20, loyalty: 70, pet: 80},
            {title: "LOYAL HOUND", color: "#2E5FFF", memory: 0, loyalty: 100, pet: 100}
        ];

        function updateCountdownTimer() {
            const timeLeft = Math.max(0, endTime - Date.now());
            const h = Math.floor(timeLeft / 3600000).toString().padStart(2, '0');
            const m = Math.floor((timeLeft % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, '0');
            document.getElementById('countdownTimer').textContent = `${h}:${m}:${s}`;
            
            if (timeLeft <= 0) {
                localStorage.removeItem('dogObedience');
                localStorage.removeItem('dogClicks');
                window.location.href = '../../index.html';
            }
        }

        // IMAGE SWAP
        function swapImage(stage) {
            const images = document.querySelectorAll('.dog-image');
            images.forEach((img, index) => {
                img.classList.toggle('active', index === stage);
            });
        }

        // DOG STRUGGLE POPUP
        function showDogStruggle(options) {
            const popup = document.getElementById("dogStrugglePopup");
            const imgBox = document.getElementById("dogFlashImage");
            const textBox = document.getElementById("dogFlashText");

            if (!popup || !imgBox || !textBox) return;

            if (options.image) {
                imgBox.style.backgroundImage = `url("${options.image}")`;
            } else {
                imgBox.style.backgroundImage = "linear-gradient(135deg, #4A90E2, #2E5FFF, #6FC6FF)";
            }

            textBox.innerHTML = options.text;
            popup.style.display = "flex";
            popup.style.opacity = "1";

            const dur = options.duration || 3500;
            setTimeout(() => {
                popup.style.opacity = "0";
                setTimeout(() => {
                    popup.style.display = "none";
                }, 400);
            }, dur);
        }

        // MEMORY TOGGLE
        function toggleMemory(id) {
            const contents = document.querySelectorAll('.memory-content');
            const target = contents[id];
            const triggers = document.querySelectorAll('.memory-trigger');
            
            contents.forEach((content, index) => {
                if (index !== id) {
                    content.classList.remove('active');
                    triggers[index].style.background = 'linear-gradient(90deg, rgba(74, 144, 226, 0.2), rgba(144, 238, 144, 0.15))';
                }
            });
            
            target.classList.toggle('active');
            triggers[id].style.background = target.classList.contains('active') ? 
                'linear-gradient(90deg, #4A90E2, #90EE90)' : 
                'linear-gradient(90deg, rgba(74, 144, 226, 0.2), rgba(144, 238, 144, 0.15))';
            
            document.getElementById('statusText').textContent = 
                `Memory #${id+1} accessed. Humanity fading... `;
        }

        // OBEDIENCE UPDATE
        function updateObedience() {
            const stage = obedienceStages[Math.min(Math.floor(obedienceLevel), 3)];
            const percentage = Math.floor(Math.min(100, (obedienceLevel) * 25));

            document.getElementById('obediencePercentage').textContent = percentage + '%';
            document.getElementById('obedienceFill').style.width = percentage + '%';
            
            document.getElementById('memoryLoss').textContent = stage.memory + '%';
            document.getElementById('selfAwareness').textContent = stage.loyalty + '%';
            document.getElementById('objectPerception').textContent = stage.pet + '%';

            const activeImage = document.querySelector('.dog-image.active');
            if (activeImage) {
                const grayscale = Math.min(100, percentage / 2);
                const brightness = 1 - (percentage / 200);
                activeImage.style.filter = `grayscale(${grayscale}%) brightness(${brightness})`;
                if (percentage > 70) activeImage.classList.add('mind-broken');
            }

            localStorage.setItem('dogObedience', Math.floor(obedienceLevel));

            if (percentage >= 25) swapImage(1);
            if (percentage >= 50) swapImage(2);
            if (percentage >= 75) swapImage(3);
            if (percentage >= 100 && !document.querySelector('#gameOverTimer')) triggerGameOver();
        }

        // ACTIONS
        function resist() {
            closeDetails();
            resistanceClicks++;
            document.getElementById('statusText').textContent = 'Collar zaps! Thoughts scattering... resistance weakening... ';
            
            const img = document.querySelector('.dog-image.active');
            img.style.transform = 'scale(1.1)';
            setTimeout(() => img.style.transform = '', 400);
            
            obedienceLevel += 0.08;
            showMindBreakPulse(2);
            updateObedience();
            localStorage.setItem('dogClicks', resistanceClicks);

            if (Math.random() < 0.7) {
                showDogStruggle({
                    image: null,
                    text: "<span class='dog-scream'>Can't... think...</span> Collar pulses with pain. But somehow it feels good. My fingers‚Äîpaws now‚Äîscratch at dirt. Only simple thoughts: <span class='happy-dog'>Master. Food. Love.</span>",
                    duration: 3800,
                });
            }
        }

        function bark() {
            closeDetails();
            resistanceClicks += 2;
            document.body.style.animation = 'shake 0.6s';
            document.getElementById('statusText').textContent = '*WOOF WOOF!* Voice gone! Only dog sounds now! ';
            
            obedienceLevel += 0.1;
            showMindBreakPulse(4);
            updateObedience();
            setTimeout(() => document.body.style.animation = '', 600);

            if (Math.random() < 0.7) {
                showDogStruggle({
                    image: null,
                    text: "The bark erupts unbidden‚Äîdeep, genuine, <span class='scream'>not mine!</span> But it feels... right. Throat vibrates. Tongue lolling. <span class='master-speak'>'Good puppy,'</span> Nami pats my head. Warmth floods through me. I want more pats. I need them.",
                });
            }
        }

        function fetch() {
            closeDetails();
            resistanceClicks += 3;
            createFloatingBones();
            document.getElementById('statusText').textContent = '"Fetch... yes... anything for her..." ';
            
            obedienceLevel += 0.2;
            showMindBreakPulse(8);
            updateObedience();

            if (Math.random() < 0.7) {
                showDogStruggle({
                    image: null,
                    text: "The toy flies‚Äî<span class='happy-dog'>I must have it!</span> Legs pumping, pure instinct. No thought. Just chase, catch, return. <span class='master-speak'>'Such a good boy!'</span> Pride explodes in my chest. I AM good. I AM perfect. For her.",
                });
            }
        }

        function obey() {
            closeDetails();
            if (Math.random() < 0.2) {
                document.getElementById('statusText').textContent = 'Nami shows mercy! A moment of clarity... (So rare...)';
            } else {
                resistanceClicks++;
                obedienceLevel += 0.3;
                document.getElementById('statusText').textContent = 'LOYALTY OVERWHELMING! Urge to please unbearable! üî•‚ù§Ô∏è';
                showMindBreakPulse(4);
                updateObedience();

                if (Math.random() < 0.7) {
                    showDogStruggle({
                        image: null,
                        text: "<span class='dog-scream'>Need to please!</span> Every muscle responds to her will. Tail wagging so hard it aches. All I want is her praise. <span class='happy-dog'>Yes yes yes!</span> Complete surrender. Complete devotion. <span class='final-dog'>Her loyal hound forever. Woof~</span>",
                        duration: 4200,
                    });
                }
            }
        }

        function closeDetails() {
            const details = document.querySelector('details[summary*="Your Loyal Dog"]');
            if (details && details.open) {
                details.open = false;
            }
        }

        function showMindBreakPulse(intensity) {
            const bar = document.getElementById('obedienceFill');
            const percent = document.getElementById('obediencePercentage');
            
            const colors = ['#90EE90', '#FFD700', '#FF8C00', '#FF4500', '#2E5FFF'];
            const pulseColor = colors[Math.min(intensity-1, colors.length-1)];
            
            bar.style.boxShadow = `0 0 20px ${pulseColor}, inset 0 0 20px ${pulseColor}`;
            percent.style.color = pulseColor;
            percent.style.textShadow = `0 0 15px ${pulseColor}`;
            
            const oldPercent = parseInt(percent.textContent);
            setTimeout(() => {
                const gain = Math.floor((obedienceLevel / 10) * 25);
                document.getElementById('statusText').textContent += ` [+${gain-oldPercent}%] `;
            }, 100);
            
            setTimeout(() => {
                bar.style.boxShadow = '';
                percent.style.color = '';
                percent.style.textShadow = '';
            }, 800);
        }

        function createFloatingBones() {
            for (let i = 0; i < 12; i++) {
                const bone = document.createElement('div');
                bone.innerHTML = 'ü¶¥';
                bone.style.cssText = `
                    position: fixed; left: ${Math.random()*90}vw; top: 50vh;
                    font-size: ${1.2+Math.random()*1}rem; pointer-events: none;
                    animation: floatUp 3s ease-out forwards; z-index: 9999;
                `;
                document.body.appendChild(bone);
                setTimeout(() => bone.remove(), 3000);
            }
        }

        function triggerGameOver() {
            triggerObedienceVictory();
            
            setTimeout(() => {
                document.body.innerHTML = `
                <div style="position:fixed;inset:0;background:linear-gradient(45deg,#2E5FFF,#0f1a2a);display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:'Orbitron',sans-serif;color:#4A90E2;text-align:center;z-index:99999;padding:20px;">
                    <h1 style="font-size:5rem;text-shadow:0 0 40px #2E5FFF;margin:0;animation:glitch 0.3s infinite;"> TRANSFORMATION COMPLETE </h1>
                    <div style="font-size:2.5rem;margin:20px;font-weight:700;">NAMI'S PERFECT HOUND ACHIEVED</div>
                    <div style="font-size:1.4rem;max-width:700px;line-height:1.6;margin:30px;">
                        You are now Nami's most loyal companion. No thoughts beyond serving her. No desires but her happiness. Just bark, obey, and love...
                    </div>
                    <img src="https://i.ibb.co/mV6DRnbb/d18.png" style="width:350px;margin:30px;border-radius:25px;box-shadow:0 0 60px #4A90E2;">
                    <div id="gameOverTimer" style="font-size:3.5rem;font-weight:700;color:#90EE90;text-shadow:0 0 30px #32CD32;">Staying with Nami in: 00:30</div>
                </div>
                `;
                
                let countdown = 30;
                const timer = setInterval(() => {
                    const minutes = Math.floor(countdown / 60).toString().padStart(2, '0');
                    const seconds = (countdown % 60).toString().padStart(2, '0');
                    document.getElementById('gameOverTimer').textContent = `Staying with Nami in: ${minutes}:${seconds}`;
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(timer);
                        localStorage.removeItem('dogObedience');
                        localStorage.removeItem('dogClicks');
                        location.reload();
                    }
                }, 1000);
            }, 20500);
        }

        function triggerObedienceVictory() {
            const state = JSON.parse(localStorage.getItem('farmState') || '{}');
            state.trappedUntil += 24 * 60 * 60 * 1000;
            localStorage.setItem('farmState', JSON.stringify(state));
            
            const overlay = document.createElement('div');
            overlay.id = 'victoryOverlay';
            overlay.style.cssText = `
                position:fixed;inset:0;z-index:100000;background:rgba(46,95,255,0.95);
                display:flex;align-items:center;justify-content:center;text-align:center;
                font-family:'Orbitron',sans-serif;pointer-events:none;overflow:hidden;
            `;
            
            overlay.innerHTML = `
                <div id="victoryTimerDisplay" style="
                    font-size:8rem;font-weight:900;color:#4A90E2;
                    text-shadow:0 0 80px #2E5FFF,0 0 160px #4A90E2;
                    letter-spacing:16px;margin:0;animation:timerExplode 20s linear infinite;
                    position:relative;z-index:10;pointer-events:none;
                ">+24:00:00</div>
                <div id="bulkyFlashes" style="position:absolute;inset:0;pointer-events:none;"></div>
            `;
            
            document.body.appendChild(overlay);
            
            let flashCount = 0;
            const bulkyMessages = [
                "COLLAR LOCKED FOREVER",
                "HUMAN MIND ERASED COMPLETELY",
                "CANINE INSTINCT ACTIVATED",
                "+24 HOURS DOG LIFE EXTENSION",
                "LOYALTY TO NAMI ABSOLUTE",
                "OBEDIENCE PROGRAM COMPLETE",
                "NAMI'S PERFECT PET",
                "TAIL WAGGING PERPETUALLY",
                "HERD INTEGRATION COMPLETE",
                "BEST BOY FOREVER UPGRADED"
            ];
            
            const flashInterval = setInterval(() => {
                if (flashCount >= bulkyMessages.length) return;
                
                const flash = document.createElement('div');
                flash.innerHTML = bulkyMessages[flashCount];
                flash.style.cssText = `
                    position:absolute;font-size:2.2rem;font-weight:900;color:#b0d4ff;
                    text-shadow:0 0 15px #2E5FFF;background:linear-gradient(135deg,#1a2535,#0f1a2a);
                    border:3px solid #4A90E2;box-shadow:0 0 40px rgba(74,144,226,0.9);
                    border-radius:20px;padding:20px 30px;left:${Math.random()*60+20}%;
                    top:${Math.random()*50+15}%;animation:bulkyFlash 3s ease-out forwards;
                    z-index:5;pointer-events:none;font-family:'Orbitron',sans-serif;
                    text-transform:uppercase;letter-spacing:2px;
                `;
                document.getElementById('bulkyFlashes').appendChild(flash);
                flashCount++;
            }, 1800);
            
            let victoryTime = 20;
            const victoryTimer = setInterval(() => {
                victoryTime--;
                document.getElementById('victoryTimerDisplay').textContent = `+24:00:00`;
                
                if (victoryTime <= 0) {
                    clearInterval(victoryTimer);
                    clearInterval(flashInterval);
                    overlay.remove();
                }
            }, 1000);
        }

        // INIT
        setInterval(updateCountdownTimer, 1000);
        updateCountdownTimer();
        updateObedience();

        setInterval(() => {
            if (Math.random() < 0.15) {
                const statuses = [
                    'Collar hums... thoughts simplifying...',
                    'Paws twitching... instinct rising...',
                    'Master scent detected! Tail wagging!',
                    `Obedience spreading... ${Math.floor(obedienceLevel * 25)}% dog...`
                ];
                document.getElementById('statusText').textContent = statuses[Math.floor(Math.random() * statuses.length)];
            }
        }, 10000);

        const style = document.createElement('style');
        style.textContent = `
            @keyframes floatUp {
                0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                100% { transform: translateY(-120vh) rotate(720deg); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
